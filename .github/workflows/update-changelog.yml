name: Auto Update CHANGELOG

on:
  push:
    branches:
      - main

jobs:
  changelog-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ensure we fetch enough history for diff

      - name: Show recent commits
        run: git log --oneline -n 5  # 🧪 This is your debug line

      - name: Set up Git
        run: |
          git config --global user.name "Auto Changelog Bot"
          git config --global user.email "noreply@example.com"

      - name: Detect major changes
        id: detect
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
          grep -E 'audio/|lyrics/|metadata/|license-forms/' changed_files.txt || echo "No major changes" > flag.txt

      - name: Update CHANGELOG if changes found
        if: success() && (steps.detect.outputs.flag != 'No major changes')
        run: |
          echo "\n## [Auto Update] - $(date +'%Y-%m-%d')" >> CHANGELOG.md
          echo "### Added or Modified Files:" >> CHANGELOG.md
          cat changed_files.txt >> CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "📜 Update CHANGELOG.md automatically"
          
          # 🔐 Authenticate using GITHUB_TOKEN before pushing
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git pull --rebase
          git push